# Pipes and Filters

## 示例

Mocha 编译器：

<img src="F:\研一春\高级软件工程\POSA\Figures\mocha_demo.png" style="zoom:50%;" />

## 背景

处理数据流；

## 问题

对输入数据流进行处理 or 转换，以单个组件的方式实现这个系统可能不可行。需要提供灵活性，以便能够更换处理步骤 or 调整处理顺序。

## 解决方案

processing pipeline:
$$
数据源\xrightarrow{管道} 过滤器\xrightarrow{管道} 数据接收器
$$

## 结构

- 过滤器：流水线的处理单元，可由多种事件触发：
  - 下一流水线元素从过滤器拉取输出（拉式过滤器，被动过滤器）；
  - 上一流水线元素向过滤器推送输入（推式过滤器，被动过滤器）；
  - 过滤器不断循环，从上游拉取输入，向下游推送输出（主动过滤器）

- 管道：
  - 如果连接的是两个主动过滤器，管道负责将他们同步，可以由 FCFO 缓冲区实现；
  - 如果连接的是一个主动过滤器和一个被动过滤器，可以直接让主动过滤器调用被动过滤器（但是会增加重组过滤器的难度）
- 数据源：可以主动向第一个过滤器推送数据，也可以由第一个过滤器来拉取数据；
- 数据接收器：可以主动拉取最后一个过滤器的输出，也可以被动接收最后一个过滤器的推送。

## 动态

下面介绍四种流水线结构，注意前三种并没有显式的“管道”这一概念。

### 推式流水线

<img src="F:\研一春\高级软件工程\POSA\Figures\push pipeline.png" style="zoom:60%;" />

### 拉式流水线

<img src="F:\研一春\高级软件工程\POSA\Figures\pull pipeline.png" style="zoom:60%;" />

### 推-拉流水线

<img src="F:\研一春\高级软件工程\POSA\Figures\mixed push-pull pipeline.png" style="zoom:60%;" />

数据源和数据接收器都是被动的，由 Filter2 主动发起处理过程。

### 全主动流水线

<img src="F:\研一春\高级软件工程\POSA\Figures\typical pipeline.png" style="zoom:60%;" />

最常见的流水线结构。所有过滤器都主动拉取数据、执行计算并推送数据，因此需要管道来保证多个过滤器线程之间的同步：

1. Filter2 读取管道，发现没有新数据；
2. Filter1 从数据源拉取数据，执行函数 f1；
3. Filter1 将结果推送给管道；
4. Filter2 从管道读取数据，执行 f2，将数据写入数据接收器；

注意如果管道（缓冲区）已满，则 Filter1 无法写入数据。

## 实现

## 效果

优点：

- 不需要中间文件；
- 可更换过滤器；
- 可重新排列过滤器 or 添加新的过滤器；
- 可重用过滤器组件；
- 效率因并行处理而得以提高；
- 可快速创建流水线原型；

缺点：

>  详见原书；